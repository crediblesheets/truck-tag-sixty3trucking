<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manage Users ‚Äî Sixty-3 Trucking</title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/admin.css">

  <style>
    /* ============================================================
       ENHANCED ADMIN USERS PAGE ‚Äî Modern, Professional, Premium
       ============================================================ */

    /* Overall page improvements */
    .page-wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }

    .sidebar {
      position: sticky;
      top: 20px;
    }

    /* ========== SIDEBAR CARD IMPROVEMENTS ========== */
    .card.admin-card {
      background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,.95) 100%);
      border: 1px solid rgba(148,163,184,.22);
      box-shadow: 0 8px 24px rgba(2,8,23,.08);
      border-radius: 16px;
      padding: 18px;
    }

    .admin-card label {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .4px;
      text-transform: uppercase;
      color: #334155;
      display: block;
      margin-bottom: 8px;
    }

    .search-box {
      display: block;
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid rgba(148,163,184,.30);
      border-radius: 12px;
      box-sizing: border-box;
      background: rgba(255,255,255,.9);
      font-size: 14px;
      color: var(--text);
      transition: all .2s ease;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(14,165,233,.15);
      background: #fff;
    }

    .search-box::placeholder {
      color: rgba(100,116,139,.65);
    }

    /* Filter chips */
    .seg {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .seg .chipbtn {
      border: 1.5px solid rgba(148,163,184,.28);
      background: rgba(255,255,255,.7);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      transition: all .2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .seg .chipbtn:hover:not(.active) {
      background: rgba(255,255,255,.9);
      border-color: rgba(148,163,184,.35);
    }

    .chipbtn.active {
      background: linear-gradient(135deg, rgba(14,165,233,.15) 0%, rgba(14,165,233,.10) 100%);
      border-color: rgba(14,165,233,.40);
      color: #0369a1;
      box-shadow: 0 4px 12px rgba(14,165,233,.12);
    }

    .muted-small {
      font-size: 11px;
      color: rgba(100,116,139,.75);
      font-weight: 600;
    }

    /* Action buttons in sidebar */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 14px;
    }

    .btn {
      font-weight: 700;
      font-size: 13px;
      letter-spacing: .2px;
      transition: all .15s ease;
    }

    .btn:not(.danger) {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(37,99,235,.18);
    }

    .btn:not(.danger):hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37,99,235,.25);
    }

    .btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(239,68,68,.18);
    }

    .btn.danger:hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(239,68,68,.25);
    }

    /* User lists in sidebar */
    .stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 14px;
    }

    .list-wrap {
      border: 1.5px solid rgba(148,163,184,.22);
      border-radius: 14px;
      background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,.95) 100%);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 36vh;
      box-shadow: 0 4px 12px rgba(2,8,23,.04);
    }

    .list-wrap .meta {
      padding: 12px 14px;
      font-size: 12px;
      font-weight: 700;
      color: #334155;
      border-bottom: 1.5px solid rgba(148,163,184,.15);
      background: linear-gradient(135deg, #f8fafc 0%, rgba(248,250,252,.95) 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      letter-spacing: .3px;
    }

    .list-items {
      overflow: auto;
      flex: 1;
    }

    .list-items::-webkit-scrollbar {
      width: 6px;
    }

    .list-items::-webkit-scrollbar-track {
      background: transparent;
    }

    .list-items::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,.25);
      border-radius: 3px;
    }

    .list-items::-webkit-scrollbar-thumb:hover {
      background: rgba(148,163,184,.40);
    }

    .user-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      width: 100%;
      padding: 11px 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      text-align: left;
      border-bottom: 1px solid rgba(148,163,184,.12);
      font-weight: 600;
      color: #334155;
      transition: all .15s ease;
      position: relative;
    }

    .user-btn:last-child {
      border-bottom: none;
    }

    .user-btn:hover {
      background: rgba(14,165,233,.05);
    }

    .user-btn.active {
      background: linear-gradient(90deg, rgba(14,165,233,.12) 0%, rgba(14,165,233,.06) 100%);
      color: #0369a1;
      border-left: 3px solid var(--primary);
      padding-left: 9px;
    }

    .user-btn:active {
      transform: translateY(1px);
    }

    .user-sub {
      font-size: 12px;
      color: rgba(100,116,139,.75);
      font-weight: 500;
    }

    /* ========== MAIN DETAIL CARD ========== */
    .detail-card {
      background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,.97) 100%);
      border: 1.5px solid rgba(148,163,184,.22);
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(2,8,23,.08);
      padding: 24px;
    }

    .detail-card > div:first-child {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      border-bottom: 1.5px solid rgba(148,163,184,.15);
      padding-bottom: 16px;
    }

    #userHdr {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -.3px;
      color: #0f172a;
    }

    .detail-card .actions {
      margin: 0;
    }

    /* Form improvements */
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .grid4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .detail-card label {
      font-size: 12px;
      color: #334155;
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .detail-card input,
    .detail-card select {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid rgba(148,163,184,.28);
      border-radius: 12px;
      box-sizing: border-box;
      background: rgba(255,255,255,.9);
      font-size: 14px;
      color: var(--text);
      transition: all .2s ease;
      font-weight: 500;
    }

    .detail-card input:focus,
    .detail-card select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(14,165,233,.15);
      background: #fff;
    }

    .detail-card input::placeholder {
      color: rgba(100,116,139,.65);
    }

    /* Password section styling */
    .detail-card section.card {
      border: 1.5px solid rgba(148,163,184,.20);
      background: linear-gradient(135deg, rgba(248,250,252,.8) 0%, rgba(248,250,252,.95) 100%);
      margin-top: 16px;
    }

    .detail-card section h3 {
      font-size: 14px;
      font-weight: 800;
      color: #334155;
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .detail-card section .muted-small {
      color: rgba(100,116,139,.80);
      line-height: 1.5;
    }

    #f_newPw {
      font-family: 'Courier New', monospace;
    }

    /* ========== TABLE IMPROVEMENTS ========== */
    .table-card {
      margin-top: 20px;
      border: 1.5px solid rgba(148,163,184,.22);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 4px 16px rgba(2,8,23,.06);
    }

    .scroll-area {
      max-height: calc(100vh - 380px);
      overflow: auto;
    }

    .scroll-area::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scroll-area::-webkit-scrollbar-track {
      background: transparent;
    }

    .scroll-area::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,.22);
      border-radius: 4px;
    }

    .scroll-area::-webkit-scrollbar-thumb:hover {
      background: rgba(148,163,184,.35);
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    .data-table thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, #f8fafc 0%, rgba(248,250,252,.95) 100%);
      text-align: left;
      padding: 14px 16px;
      border-bottom: 1.5px solid rgba(148,163,184,.20);
      font-weight: 800;
      letter-spacing: .3px;
      color: #334155;
      text-transform: uppercase;
      font-size: 12px;
    }

    .data-table tbody td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(226,232,240,.8);
      color: #475569;
    }

    .data-table tbody tr {
      transition: all .15s ease;
    }

    .data-table tbody tr:hover {
      background: linear-gradient(90deg, rgba(14,165,233,.05) 0%, transparent 100%);
    }

    .data-table a.rowLink {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      transition: all .15s ease;
    }

    .data-table a.rowLink:hover {
      color: #0369a1;
      text-decoration: underline;
    }

    /* Table columns */
    .col-ticket {
      width: 120px;
      white-space: nowrap;
    }

    .col-email {
      min-width: 280px;
    }

    .col-updated {
      min-width: 200px;
      white-space: nowrap;
      color: var(--muted);
    }

    .col-status {
      width: 140px;
      white-space: nowrap;
    }

    .row-chk {
      width: 44px;
      text-align: center;
    }

    .data-table input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      transition: transform .1s ease;
    }

    .data-table input[type="checkbox"]:hover {
      transform: scale(1.1);
    }

    /* Badge improvements */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      letter-spacing: .2px;
      text-transform: uppercase;
    }

    .badge-done {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      color: #065f46;
      border-color: rgba(34,197,94,.25);
      box-shadow: 0 4px 12px rgba(34,197,94,.12);
    }

    .badge-other {
      background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%);
      color: #3730a3;
      border-color: rgba(99,102,241,.25);
      box-shadow: 0 4px 12px rgba(99,102,241,.12);
    }

    /* Loading overlay improvements */
    #overlay {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    #overlay.show {
      display: flex;
    }

    #overlay::backdrop,
    .loading-overlay {
      background: rgba(15,23,42,.55);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .loading-box,
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,.60);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loading-box {
      position: relative;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      min-width: 280px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(2,8,23,.20);
      border: 1px solid rgba(148,163,184,.20);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid rgba(148,163,184,.20);
      border-top-color: var(--primary);
      margin: 0 auto 12px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
    }

    /* ========== RESPONSIVE IMPROVEMENTS ========== */
    @media (max-width: 1200px) {
      .grid4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 980px) {
      .page-wrap {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
      }

      .grid2,
      .grid4 {
        grid-template-columns: 1fr;
      }

      .list-wrap {
        max-height: unset;
      }

      .actions {
        flex-direction: row;
      }

      .detail-card {
        padding: 18px;
      }
    }

    @media (max-width: 640px) {
      .page-wrap {
        gap: 12px;
      }

      .sidebar {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        grid-column: 1 / -1;
      }

      .admin-card,
      .list-wrap {
        grid-column: auto;
      }

      .detail-card {
        grid-column: 1 / -1;
        padding: 14px;
      }

      .detail-card > div:first-child {
        flex-direction: column;
        align-items: flex-start;
      }

      #userHdr {
        font-size: 18px;
      }

      .grid2,
      .grid4 {
        grid-template-columns: 1fr;
      }
    }

    /* Utility classes */
    .form-error {
      margin: 12px 0 0;
      padding: 12px 14px;
      border: 1.5px solid rgba(239,68,68,.25);
      background: linear-gradient(135deg, #fef2f2 0%, rgba(254,242,242,.95) 100%);
      color: #7f1d1d;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .input-invalid {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 4px rgba(239,68,68,.12) !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner" style="grid-template-columns:auto 1fr auto;">
      <div class="brand">
        <img src="/assets/img/logo.png" class="logo" alt="Sixty ‚Äì 3 logo">
        <span class="brand-text">Sixty ‚Äì 3 Trucking Inc</span>
      </div>
      <div class="title-wrap" style="justify-content:flex-start;">
        <h1 class="page-title">Manage Users</h1>
        <p class="subtitle">Add admins/drivers, activate/deactivate, and bulk delete</p>
      </div>
      <div>
        <a href="/admin" class="btn">‚Üê Back to Admin</a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-bottom:28px;">
    <div class="page-wrap">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="card admin-card">
          <label for="userSearch">üîç Search users</label>
          <input id="userSearch" class="search-box" type="search" placeholder="Name, email, or role" autocomplete="off">

          <div class="seg" role="tablist" aria-label="Filter users">
            <button id="segAll" class="chipbtn active" role="tab" aria-selected="true">
              <span>All Users</span>
              <span class="muted-small" id="userCountAll">(0)</span>
            </button>
            <button id="segDrivers" class="chipbtn" role="tab" aria-selected="false">
              <span>Drivers</span>
              <span class="muted-small" id="segDriversCount">(0)</span>
            </button>
            <button id="segAdmins" class="chipbtn" role="tab" aria-selected="false">
              <span>Admins</span>
              <span class="muted-small" id="segAdminsCount">(0)</span>
            </button>
          </div>

          <div class="actions">
            <button id="addBtn" class="btn">‚ûï Add New User</button>
            <button id="bulkDeleteBtn" class="btn danger">üóë Delete Selected</button>
          </div>
        </div>

        <div class="stack">
          <!-- Drivers group -->
          <div class="list-wrap" aria-label="Drivers list">
            <div class="meta">
              <span>üë• Drivers</span>
              <span id="driverCount" style="background: rgba(14,165,233,.12); color: #0369a1; padding: 2px 8px; border-radius: 999px; font-size: 11px;">0</span>
            </div>
            <div id="driverList" class="list-items">
              <div class="muted-small" style="padding:12px;">No drivers.</div>
            </div>
          </div>

          <!-- Admins group -->
          <div class="list-wrap" aria-label="Admins list">
            <div class="meta">
              <span>üîê Admins</span>
              <span id="adminCount" style="background: rgba(99,102,241,.12); color: #3730a3; padding: 2px 8px; border-radius: 999px; font-size: 11px;">0</span>
            </div>
            <div id="adminList" class="list-items">
              <div class="muted-small" style="padding:12px;">No admins.</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Detail + table -->
      <section class="card detail-card">
        <div>
          <h2 id="userHdr">User ‚Äî</h2>
          <div class="actions">
            <button id="saveBtn" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; border: none; box-shadow: 0 4px 12px rgba(16,185,129,.18);">‚úì Save Changes</button>
          </div>
        </div>

        <!-- User Details Form -->
        <div class="grid4" style="margin-bottom: 20px;">
          <div>
            <label>Email (sign-in)</label>
            <input id="f_email" type="email" placeholder="name@company.com">
          </div>
          <div>
            <label>Full name</label>
            <input id="f_fullName" type="text" placeholder="Jane Doe">
          </div>
          <div>
            <label>Role</label>
            <select id="f_role">
              <option value="driver">Driver</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="f_active">
              <option value="true">‚úì Active</option>
              <option value="false">‚úó Disabled</option>
            </select>
          </div>
        </div>

        <div class="actions" style="justify-content:flex-start; margin-bottom: 16px;">
          <button id="deleteBtn" class="btn danger">üóë Delete User</button>
        </div>

        <!-- Password Management Section -->
        <section class="card detail-card">
          <h3 style="margin:0 0 8px;">üîë Password Management</h3>
          <p class="muted-small" style="margin:0 0 14px; line-height:1.5;">
            Set a temporary or new password, or clear it so the user must create one on next sign-in.
          </p>

          <div class="grid2" style="margin-bottom: 14px; align-items:end;">
            <div>
              <label>New password</label>
              <input id="f_newPw" type="text" placeholder="Min. 8 chars, include a number" style="font-size:13px;">
            </div>
            <div style="display:flex; gap:10px;">
              <button id="btnSetPw" class="btn" style="flex:1; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: #fff; border: none; box-shadow: 0 4px 12px rgba(37,99,235,.18); font-size: 13px;">
                Set Password
              </button>
              <button id="btnClearPw" class="btn danger" type="button" style="flex:1; font-size: 13px;">
                Clear Password
              </button>
            </div>
          </div>

          <p class="muted-small" style="margin:0; font-size:12px; line-height:1.5;">
            ‚Ñπ Clearing sets password to null. On next login, user must create one via setup flow.
          </p>
        </section>

        <!-- Users Data Table -->
        <div class="table-card">
          <div class="scroll-area">
            <table class="data-table" aria-label="Users">
              <thead>
                <tr>
                  <th class="row-chk"><input id="chkAll" type="checkbox" aria-label="Select all"></th>
                  <th>Email</th>
                  <th>Full Name</th>
                  <th>Role</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr><td colspan="5" style="text-align:center; padding: 24px; color: var(--muted);">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>¬© <span id="y"></span> Sixty ‚Äì 3 Trucking Inc. All rights reserved.</small>
    </div>
  </footer>

  <!-- Loading overlay -->
  <div id="overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-box" role="dialog" aria-live="polite">
      <div class="spinner"></div>
      <div id="overlayText" class="loading-text">Working‚Ä¶</div>
    </div>
  </div>

  <script>
    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // ---------- helpers ----------
    const $  = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    const ltrim = v => String(v ?? '').trim().toLowerCase();

    function showOverlay(msg='Working‚Ä¶'){ $('#overlayText').textContent = msg; $('#overlay').classList.add('show'); $('#overlay').setAttribute('aria-hidden','false'); }
    function hideOverlay(){ $('#overlay').classList.remove('show'); $('#overlay').setAttribute('aria-hidden','true'); }

    function toast(msg){ alert(msg); }

    // ---------- state ----------
    let ALL = [];           // [{email, full_name, role, active}]
    let FILTER = 'all';     // 'all' | 'driver' | 'admin'
    let CURRENT = null;     // {email,...}
    let selectedEmails = new Set(); // table checkboxes
    let searchQ = '';

    // ---------- load users ----------
    async function loadUsers(){
      showOverlay('Loading users‚Ä¶');
      try{
        const r = await fetch('/api/admin/users?q=' + encodeURIComponent(searchQ));
        if (r.status === 401 || r.status === 403) { location.href = '/'; return; }
        const j = await r.json();
        if (!j.ok && !Array.isArray(j.users)) throw new Error(j.message || 'Failed');
        ALL = (j.users || []).map(u => ({
          email: String(u.email||'').toLowerCase(),
          full_name: u.full_name || '',
          role: (u.role||'driver').toLowerCase()==='admin' ? 'admin' : 'driver',
          active: !!u.active
        }));
        renderEverything();
      }catch(e){
        console.error(e);
        toast('Failed to load users.');
        ALL = [];
        renderEverything();
      }finally{
        hideOverlay();
      }
    }

    // ---------- renders ----------
    function renderEverything(){
      renderLists();
      renderTable();
      if (CURRENT){
        const found = ALL.find(u => u.email === CURRENT.email);
        if (found) fillForm(found); else clearForm();
      }else{
        clearForm();
      }
    }

    function renderLists(){
      const drivers = ALL.filter(u => u.role === 'driver');
      const admins  = ALL.filter(u => u.role === 'admin');

      // counts
      $('#driverCount').textContent = drivers.length;
      $('#adminCount').textContent  = admins.length;
      $('#userCountAll').textContent = `(${ALL.length})`;
      $('#segDriversCount').textContent = `(${drivers.length})`;
      $('#segAdminsCount').textContent = `(${admins.length})`;

      // helpers
      const mkBtn = (u) => `
        <button class="user-btn" data-email="${u.email.replace(/"/g,'&quot;')}">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${u.full_name || u.email}</div>
            <div class="user-sub">${u.email}</div>
          </div>
          <div style="font-size: 11px; font-weight: 700; background: ${u.active ? 'rgba(34,197,94,.12)' : 'rgba(107,114,128,.12)'}; color: ${u.active ? '#065f46' : '#374151'}; padding: 2px 8px; border-radius: 999px; white-space: nowrap;">
            ${u.active ? 'Active' : 'Disabled'}
          </div>
        </button>`;

      // drivers
      const dl = $('#driverList');
      dl.innerHTML = drivers.length
        ? drivers.map(mkBtn).join('')
        : `<div class="muted-small" style="padding:12px;">No drivers.</div>`;

      // admins
      const al = $('#adminList');
      al.innerHTML = admins.length
        ? admins.map(mkBtn).join('')
        : `<div class="muted-small" style="padding:12px;">No admins.</div>`;

      // active state on side buttons
      $$('#driverList .user-btn, #adminList .user-btn').forEach(btn => {
        btn.classList.toggle('active', CURRENT && btn.dataset.email === CURRENT.email);
      });
    }

    function renderTable(){
      const rows = $('#rows');
      let view = ALL;
      if (FILTER === 'driver') view = view.filter(u => u.role === 'driver');
      if (FILTER === 'admin')  view = view.filter(u => u.role === 'admin');

      if (!view.length){
        rows.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 24px; color: var(--muted);">No users.</td></tr>`;
        return;
      }

      rows.innerHTML = view.map(u => `
        <tr data-email="${u.email}">
          <td class="row-chk"><input type="checkbox" class="rowChk" ${selectedEmails.has(u.email)?'checked':''}></td>
          <td><a href="#" class="rowLink">${u.email}</a></td>
          <td>${u.full_name || '‚Äî'}</td>
          <td style="text-transform: capitalize; font-weight: 700; color: #334155;">${u.role}</td>
          <td>${u.active ? '<span class="badge badge-done">‚úì Active</span>' : '<span class="badge badge-other">‚úó Disabled</span>'}</td>
        </tr>
      `).join('');
    }

    // ---------- form ----------
    function fillForm(u){
      CURRENT = u;
      $('#userHdr').textContent = u.full_name ? u.full_name : u.email;
      $('#f_email').value = u.email;
      $('#f_fullName').value = u.full_name || '';
      $('#f_role').value = u.role === 'admin' ? 'admin' : 'driver';
      $('#f_active').value = u.active ? 'true' : 'false';

      // highlight in lists
      $$('#driverList .user-btn, #adminList .user-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.email === u.email);
      });
    }
    function clearForm(){
      CURRENT = null;
      $('#userHdr').textContent = 'User ‚Äî';
      $('#f_email').value = '';
      $('#f_fullName').value = '';
      $('#f_role').value = 'driver';
      $('#f_active').value = 'true';
      $$('#driverList .user-btn, #adminList .user-btn').forEach(btn => btn.classList.remove('active'));
    }

    async function setPasswordForCurrent(){
      if (!CURRENT){ toast('Select a user first.'); return; }
      const pw = $('#f_newPw').value;
      if (!pw || pw.length < 8){ toast('Enter a password with at least 8 characters (include a number).'); return; }

      try{
        showOverlay('Updating password‚Ä¶');
        const r = await fetch('/api/admin/users/' + encodeURIComponent(CURRENT.email) + '/password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ newPassword: pw })
        });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to set password');
        $('#f_newPw').value = '';
        toast('Password updated.');
      }catch(e){
        console.error(e);
        toast(e.message || 'Failed to set password.');
      }finally{
        hideOverlay();
      }
    }

    async function clearPasswordForCurrent(){
      if (!CURRENT){ toast('Select a user first.'); return; }
      if (!confirm(`Clear password for ${CURRENT.email}? They will be forced to create a new one next time.`)) return;

      try{
        showOverlay('Clearing password‚Ä¶');
        const r = await fetch('/api/admin/users/' + encodeURIComponent(CURRENT.email) + '/password', {
          method: 'DELETE'
        });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to clear password');
        toast('Password cleared. User must set a new one.');
      }catch(e){
        console.error(e);
        toast(e.message || 'Failed to clear password.');
      }finally{
        hideOverlay();
      }
    }

    // ---------- actions ----------
    async function saveCurrent(){
      const email = ltrim($('#f_email').value);
      const fullName = $('#f_fullName').value.trim();
      const role = $('#f_role').value;
      const active = $('#f_active').value === 'true';

      if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ toast('Valid email is required.'); $('#f_email').focus(); return; }
      if (!['driver','admin'].includes(role)){ toast('Role must be driver or admin.'); return; }

      const payload = { email, fullName, role, active };
      try{
        showOverlay(CURRENT ? 'Saving user‚Ä¶' : 'Adding user‚Ä¶');
        if (!CURRENT){
          // add
          const r = await fetch('/api/admin/users', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const j = await r.json();
          if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to add');
        } else {
          // update ‚Äî PUT /:email (key is the original email)
          const key = encodeURIComponent(CURRENT.email);
          const r = await fetch(`/api/admin/users/${key}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ fullName, role, active }) });
          const j = await r.json();
          if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to update');
        }
        await loadUsers();
        const justSaved = ALL.find(u => u.email === email);
        if (justSaved) fillForm(justSaved);
        toast('Saved.');
      }catch(e){
        console.error(e);
        toast(e.message || 'Save failed.');
      }finally{
        hideOverlay();
      }
    }

    async function deleteCurrent(){
      if (!CURRENT) { toast('No user selected.'); return; }
      if (!confirm(`Delete user ${CURRENT.email}?`)) return;
      try{
        showOverlay('Deleting user‚Ä¶');
        const r = await fetch('/api/admin/users', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ emails:[CURRENT.email] }) });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to delete');
        selectedEmails.delete(CURRENT.email);
        clearForm();
        await loadUsers();
        toast('User deleted.');
      }catch(e){
        console.error(e);
        toast(e.message || 'Delete failed.');
      }finally{
        hideOverlay();
      }
    }

    async function bulkDelete(){
      const list = Array.from(selectedEmails);
      if (!list.length){ toast('Select one or more rows first.'); return; }
      if (!confirm(`Delete ${list.length} user(s)?`)) return;
      try{
        showOverlay('Deleting users‚Ä¶');
        const r = await fetch('/api/admin/users', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ emails:list }) });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to delete');
        selectedEmails.clear();
        clearForm();
        await loadUsers();
        toast('Users deleted.');
      }catch(e){
        console.error(e);
        toast(e.message || 'Bulk delete failed.');
      }finally{
        hideOverlay();
      }
    }

    // ---------- events ----------
    // segmented filter
    $('#segAll').addEventListener('click', () => { FILTER='all'; $('#segAll').classList.add('active'); $('#segDrivers').classList.remove('active'); $('#segAdmins').classList.remove('active'); renderTable(); });
    $('#segDrivers').addEventListener('click', () => { FILTER='driver'; $('#segDrivers').classList.add('active'); $('#segAll').classList.remove('active'); $('#segAdmins').classList.remove('active'); renderTable(); });
    $('#segAdmins').addEventListener('click', () => { FILTER='admin'; $('#segAdmins').classList.add('active'); $('#segAll').classList.remove('active'); $('#segDrivers').classList.remove('active'); renderTable(); });

    // sidebar list click -> open
    $('#driverList').addEventListener('click', (e) => {
      const btn = e.target.closest('.user-btn'); if (!btn) return;
      const u = ALL.find(x => x.email === btn.dataset.email); if (u) fillForm(u);
    });
    $('#adminList').addEventListener('click', (e) => {
      const btn = e.target.closest('.user-btn'); if (!btn) return;
      const u = ALL.find(x => x.email === btn.dataset.email); if (u) fillForm(u);
    });

    // table: select row / open
    $('#rows').addEventListener('click', (e) => {
      const tr = e.target.closest('tr'); if (!tr) return;
      const email = tr.dataset.email;

      if (e.target.classList.contains('rowChk')){
        if (e.target.checked) selectedEmails.add(email); else selectedEmails.delete(email);
        return;
      }
      const link = e.target.closest('.rowLink');
      if (link){
        e.preventDefault();
        const u = ALL.find(x => x.email === email);
        if (u) fillForm(u);
      }
    });

    // select-all
    $('#chkAll').addEventListener('change', (e) => {
      const on = e.target.checked;
      const viewEmails = Array.from($('#rows').querySelectorAll('tr[data-email]')).map(tr => tr.dataset.email);
      viewEmails.forEach(em => { if (on) selectedEmails.add(em); else selectedEmails.delete(em); });
      renderTable();
    });

    // search
    $('#userSearch').addEventListener('input', async (e) => {
      searchQ = e.target.value;
      await loadUsers(); // server-side filtering
    });

    // add user (clear form to "new")
    $('#addBtn').addEventListener('click', () => { clearForm(); $('#f_email').focus(); });

    // save / delete / bulk
    $('#saveBtn').addEventListener('click', saveCurrent);
    $('#deleteBtn').addEventListener('click', deleteCurrent);
    $('#bulkDeleteBtn').addEventListener('click', bulkDelete);
    $('#btnSetPw').addEventListener('click', setPasswordForCurrent);
    $('#btnClearPw').addEventListener('click', clearPasswordForCurrent);

    // boot
    loadUsers();
  </script>
</body>
</html>