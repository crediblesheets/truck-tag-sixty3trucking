<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Truck Tag — Driver Login</title>

  <link rel="stylesheet" href="./styles.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-body">

  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="./assets/img/logo.png" class="logo" alt="Sixty – 3 logo">
        <span class="brand-text">Sixty – 3 Trucking Inc</span>
      </div>
      <div class="title-wrap">
        <h1 class="page-title">Truck Tag</h1>
        <p class="subtitle">Driver sign-in</p>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="auth-hero two-col">
      <!-- left column -->
      <div class="auth-copy">
        <span class="pill">Secure Access</span>
        <h2>Fast, simple tagging for drivers</h2>
        <p class="lead">
          Use your company email to access assigned tags and submit scale details in seconds.
        </p>
        <ul class="benefits">
          <li><span class="chk" aria-hidden="true"></span> Only your pending tags</li>
          <li><span class="chk" aria-hidden="true"></span> Mobile-friendly form</li>
          <li><span class="chk" aria-hidden="true"></span> Generates clean PDFs</li>
        </ul>
      </div>

      <!-- right column: card -->
      <div class="login-card card">
        <header class="card-head">
          <h3>Driver Login</h3>
          <p class="muted">Use your work email. Your account must be marked
            <b>Active</b> in the <i>Users</i> table.</p>
        </header>

        <form id="loginForm" class="form" novalidate>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" class="input" type="email" autocomplete="email"
                   placeholder="you@company.com" required>
          </div>

          <div class="field">
            <label for="pwd">Password</label>
            <div class="password-wrap">
              <input id="pwd" class="input" type="password" autocomplete="current-password"
                     placeholder="Your password" required>
              <button type="button" id="showPwd" class="icon-btn" aria-label="Show password" aria-pressed="false">
                <!-- eye icon -->
                <svg class="eye" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path d="M12 5c-5 0-9 4.5-9 7s4 7 9 7 9-4.5 9-7-4-7-9-7Zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z" fill="currentColor"/>
                </svg>
                <svg class="eye-off" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path d="M3 3l18 18M9.9 9.9A4 4 0 0 0 12 16a4 4 0 0 0 2.1-.6M7.1 7.6C5 8.8 3.7 10.5 3 12c1.3 2.8 5 5 9 5 1.5 0 3-.3 4.3-.9M14 5.1A10.7 10.7 0 0 0 12 5c-4 0-7.7 2.2-9 5 .6 1.2 1.7 2.4 3.1 3.3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>

          <button id="submitBtn" class="btn-primary" type="submit">
            <span class="btn-text">Sign in</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>

          <div id="msg" class="auth-msg" role="status" aria-live="polite"></div>

          <p class="tiny muted center help-text">
            Trouble signing in? Contact dispatch or email
            <a href="mailto:it@sixty3trucking.com">IT support</a>.
          </p>
        </form>

        <!-- Password setup modal -->
<div id="pwModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-backdrop"></div>
  <div class="modal-box" role="document">
    <header class="modal-head">
      <h4>Create your password</h4>
      <button type="button" id="pwClose" class="modal-x" aria-label="Close">×</button>
    </header>
    <div class="modal-body">
      <p class="muted">This account doesn’t have a password yet. Create one to continue.</p>

      <div class="field">
        <label>Email</label>
        <input id="pwEmail" class="input" type="email" readonly>
      </div>

      <div class="field">
        <label>New password</label>
        <input id="newPwd" class="input" type="password" placeholder="At least 8 characters, include a number">
      </div>

      <div class="field">
        <label>Confirm password</label>
        <input id="newPwd2" class="input" type="password" placeholder="Re-enter password">
      </div>

      <div id="pwMsg" class="auth-msg" aria-live="polite"></div>

      <div class="modal-actions">
        <button type="button" id="setPwdBtn" class="btn-primary">Create password</button>
        <button type="button" id="pwCancel" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>



      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>© <span id="y"></span> Sixty – 3 Trucking Inc</small>
    </div>
  </footer>

  <script>
  // footer year
  document.getElementById('y').textContent = new Date().getFullYear();

  const form      = document.getElementById('loginForm');
  const emailEl   = document.getElementById('email');
  const pwdEl     = document.getElementById('pwd');
  const showBtn   = document.getElementById('showPwd');
  const msgEl     = document.getElementById('msg');
  const submitBtn = document.getElementById('submitBtn');

  function setMsg(text = '', kind = '') {
    msgEl.textContent = text;
    msgEl.className = 'auth-msg ' + (kind ? kind : (text ? 'ok' : ''));
  }
  function setLoading(on) {
    submitBtn.classList.toggle('loading', !!on);
    submitBtn.disabled = !!on;
  }

  // already logged-in guard
  (async () => {
    try {
      const r = await fetch('/api/me', { credentials: 'include' });
      if (!r.ok) return;
      const j = await r.json();
      if (j.ok && j.profile) {
        const role = (j.profile.role || '').toLowerCase();
        location.replace(role === 'admin' ? '/admin' : '/dashboard.html');
      }
    } catch {}
  })();

  showBtn.addEventListener('click', () => {
    const showing = pwdEl.type === 'text';
    pwdEl.type = showing ? 'password' : 'text';
    showBtn.setAttribute('aria-pressed', String(!showing));
    showBtn.classList.toggle('on', !showing);
    pwdEl.focus({preventScroll:true});
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg('');
    setLoading(true);

    const email = emailEl.value.trim();
    const password = pwdEl.value;

    try {
      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // always include for cookie-based auth
        body: JSON.stringify({ email, password })
      });

      const d = await r.json().catch(() => ({}));

      if (!r.ok || d.ok === false) {
        setLoading(false);
        setMsg(d.message || 'Invalid email or password.', 'error');
        return;
      }

      const role = (d.role || '').toLowerCase();
      setMsg('Success. Redirecting…', 'ok');
      location.href = role === 'admin' ? '/admin' : '/dashboard.html';
    } catch (err) {
      console.error(err);
      setLoading(false);
      setMsg('Sign-in failed. Please try again.', 'error');
    }
  });
</script>


</body>
</html>
