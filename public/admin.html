<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Console — Sixty-3 Trucking</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./admin.css">
</head>

<body class="admin-body">
  <div class="admin-shell">
    <!-- Sidebar -->
    <aside class="admin-sidebar" aria-label="Admin sidebar">
      <div class="sidebar-head">
        <div class="sidebar-brand">
          <img src="./assets/img/logo.png" class="sidebar-logo" alt="Sixty – 3 logo">
          <div class="sidebar-brand-text">
            <div class="sb-title">Sixty – 3 Trucking</div>
            <div class="sb-sub">Admin Console</div>
          </div>
        </div>

        <button class="icon-btn sidebar-close" id="sidebarClose" type="button" aria-label="Close sidebar">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Actions</div>

        <button id="refreshBtn" class="btn btn-sidebar" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M20 12a8 8 0 10-2.34 5.66" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 12v-6h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Refresh
        </button>

        <button id="openAdd" class="btn btn-sidebar btn-sidebar-primary" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Add Ticket
        </button>

        <button id="openUpload" class="btn btn-sidebar" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M12 3v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 7l4-4 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4 14v5h16v-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Upload CSV
        </button>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Navigate</div>

        <button id="openTagLists" class="btn btn-sidebar" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M8 6h13M8 12h13M8 18h13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M3.5 6h.5M3.5 12h.5M3.5 18h.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Tag Lists
        </button>

        <button id="openDraftTickets" class="btn btn-sidebar" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M4 20h4l10.5-10.5a2.1 2.1 0 00-4-1L4 18v2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M13.5 6.5l4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Draft Tickets
        </button>

        <button id="openUsers" class="btn btn-sidebar" type="button">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M20 21a8 8 0 10-16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 12a4 4 0 100-8 4 4 0 000 8z" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
          Manage Users
        </button>
      </div>

      <div class="sidebar-foot">
        <div class="who">
          <div id="adminNameSmall" class="who-title">Welcome, …</div>
          <div class="who-sub">You’re in Admin mode</div>
        </div>

        <div class="sidebar-foot-row">
          <div class="muted-small">© <span id="y"></span> Sixty – 3 Trucking Inc</div>
        </div>
      </div>
    </aside>

    <div class="admin-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>

    <!-- Main -->
    <main class="admin-main">
      <header class="admin-topbar">
        <button class="icon-btn sidebar-toggle" id="sidebarToggle" type="button" aria-label="Open sidebar">
          <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <div class="topbar-title">
          <div class="topbar-kicker">Driver Tags</div>
          <div class="topbar-sub">Review, edit, and manage ticket details</div>
        </div>

        <div class="topbar-right">
          <span class="chip" id="resultMeta">Showing 0 results</span>
        </div>
      </header>

      <section class="card admin-hero">
        <div class="hero-left">
          <h2 id="adminName" class="hero-title">Welcome, …</h2>
          <p class="muted hero-sub">
            Use filters to review Driver Tags. Click a Ticket # to preview/edit Admin Ticket data.
          </p>
        </div>

        <div class="hero-right">
          <div class="hero-stat">
            <div class="stat-label">Pending</div>
            <div class="stat-value" id="statPending">—</div>
          </div>
          <div class="hero-stat">
            <div class="stat-label">Done</div>
            <div class="stat-value" id="statDone">—</div>
          </div>
          <div class="hero-stat">
            <div class="stat-label">Total</div>
            <div class="stat-value" id="statTotal">—</div>
          </div>
        </div>
      </section>

      <section class="card admin-filters">
        <div class="filters-grid">
          <div class="field">
            <label for="statusSel">Status</label>
            <select id="statusSel">
              <option value="all">All</option>
              <option value="pending" selected>Pending</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="field field-span-2">
            <label for="searchBox">Search (ticket, driver, email, material)</label>
            <input id="searchBox" type="search" placeholder="Search…">
          </div>

          <div class="field">
            <label for="startDate">Start date (Updated)</label>
            <input id="startDate" type="date" />
          </div>

          <div class="field">
            <label for="endDate">End date (Updated)</label>
            <input id="endDate" type="date" />
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button id="clearDates" type="button" class="btn">Clear dates</button>
          </div>
        </div>
      </section>

      <section class="card admin-table">
        <div class="table-card">
          <div class="scroll-area">
            <table class="data-table" aria-label="Driver tags table">
              <thead>
                <tr>
                  <th class="col-ticket">Ticket</th>
                  <th>Driver</th>
                  <th class="col-email">Email</th>
                  <th class="col-status">Status</th>
                  <th class="col-updated">Updated</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr><td colspan="5" class="muted-small" style="text-align:center;">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add Ticket Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <button class="close" data-close aria-label="Close">&times;</button>
      <h3 class="modal-title">Add Ticket</h3>

      <form id="addForm" autocomplete="off">
        <div class="grid3">
          <div>
            <label>Date</label>
            <input type="date" name="date" required>
          </div>
          <div>
            <label>Ticket No</label>
            <input type="text" name="ticketNo" required placeholder="e.g., 49250">
          </div>
          <div>
            <label>Driver Name</label>
            <select name="driverName" id="driverSel" required>
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Truck Start</label>
            <input type="text" name="truckStart" placeholder="e.g., 7:00 AM">
          </div>
          <div>
            <label>Truck No</label>
            <input type="text" name="truckNo" placeholder="e.g., 21">
          </div>
          <div>
            <label>Trailer Type</label>
            <select name="trailerType" id="trailerSel">
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Sub Hauler</label>
            <input type="text" name="subHauler">
          </div>
          <div>
            <label>Prime Carrier</label>
            <input type="text" name="primeCarrier" value="Sixty-3 Trucking">
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Shipper</label>
            <input type="text" name="shipper">
          </div>
          <div>
            <label>Point of Origin</label>
            <input type="text" name="origin">
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Origin City</label>
            <input type="text" name="originCity" placeholder="e.g., San Francisco">
          </div>
          <div>
            <label>PO No</label>
            <input type="text" name="poNo">
          </div>
          <div>
            <label>Job Name</label>
            <input type="text" name="jobName">
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Job No</label>
            <input type="text" name="jobNo">
          </div>
          <div>
            <label>Destination</label>
            <input type="text" name="destination" placeholder="e.g., (Unloaded at) 5">
          </div>
          <div>
            <label>Destination City</label>
            <input type="text" name="city" placeholder="e.g., San Francisco">
          </div>
        </div>

        <p class="muted-small" style="margin:8px 0 0;">Note: Email is linked to the driver’s account automatically.</p>

        <div class="actions">
          <button type="button" class="btn" data-close>Cancel</button>
          <button type="submit" class="btn btn-primary" id="addSaveBtn">Save Ticket</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View/Edit Ticket Modal -->
  <div id="viewModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <button class="close" data-close aria-label="Close">&times;</button>
      <h3 class="modal-title">Ticket <span id="viewId">—</span></h3>

      <form id="viewForm" autocomplete="off">
        <div class="grid3">
          <div>
            <label>Date</label>
            <input type="date" name="date" required disabled>
          </div>
          <div>
            <label>Ticket No</label>
            <input type="text" name="ticketNo" required disabled>
          </div>
          <div>
            <label>Driver Name</label>
            <select name="driverName" id="viewDriverSel" required disabled>
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Truck Start</label>
            <input type="text" name="truckStart" disabled>
          </div>
          <div>
            <label>Truck No</label>
            <input type="text" name="truckNo" disabled>
          </div>
          <div>
            <label>Trailer Type</label>
            <select name="trailerType" id="viewTrailerSel" disabled>
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Sub Hauler</label>
            <input type="text" name="subHauler" disabled>
          </div>
          <div>
            <label>Prime Carrier</label>
            <input type="text" name="primeCarrier" disabled>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Shipper</label>
            <input type="text" name="shipper" disabled>
          </div>
          <div>
            <label>Point of Origin</label>
            <input type="text" name="origin" disabled>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Origin City</label>
            <input type="text" name="originCity" disabled>
          </div>
          <div>
            <label>PO No</label>
            <input type="text" name="poNo" disabled>
          </div>
          <div>
            <label>Job Name</label>
            <input type="text" name="jobName" disabled>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Job No</label>
            <input type="text" name="jobNo" disabled>
          </div>
          <div>
            <label>Destination</label>
            <input type="text" name="destination" disabled>
          </div>
          <div>
            <label>Destination City</label>
            <input type="text" name="city" disabled>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="deleteBtn" class="btn danger">Delete</button>
          <span style="flex:1"></span>
          <button type="button" id="editBtn" class="btn warn">Edit</button>
          <button type="submit" id="saveBtn" class="btn btn-primary" style="display:none">Save</button>
          <button type="button" id="cancelEditBtn" class="btn" style="display:none">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel" role="dialog" aria-live="polite">
      <div class="spinner"></div>
      <div id="loadingMsg" class="muted-small">Working…</div>
    </div>
  </div>

  <!-- Hidden file input for CSV -->
  <input id="csvInput" type="file" accept=".csv,text/csv" style="display:none" />

  <script>
    // ---------- tiny helpers ----------
    const $  = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    const ltrim = (v) => String(v ?? '').trim().toLowerCase();

    // year
    $('#y').textContent = new Date().getFullYear();

    function fmtDateTime(t){
      if (!t) return '';
      const d = new Date(t);
      if (isNaN(d)) return String(t);
      return d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    }
    function toISODate(s){
      if (!s) return '';
      const d = new Date(s);
      if (!isNaN(d)) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
      const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) { const [_, mm, dd, yyyy] = m; return `${yyyy.padStart(4,'20')}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
      return '';
    }
    function statusBadge(s){
      const k = ltrim(s);
      const cls = k==='pending' ? 'badge-pending' : k==='done' ? 'badge-done' : 'badge-other';
      return `<span class="badge ${cls}">${s || '-'}</span>`;
    }
    function setOpen(modal, on=true){
      modal.classList.toggle('show', on);
      modal.setAttribute('aria-hidden', on ? 'false' : 'true');
    }
    function v(obj, ...keys){
      for (const k of keys){
        const val = obj?.[k];
        if (val !== undefined && String(val).trim() !== '') return String(val);
      }
      return '';
    }
    function setSelectValue(sel, value){
      if (!sel) return;
      const val = String(value || '');
      const has = Array.from(sel.options).some(o => o.value === val);
      if (val && !has){
        const opt = document.createElement('option');
        opt.value = val; opt.textContent = val;
        sel.appendChild(opt);
      }
      sel.value = val;
    }

    // Button loading (spinner on the button itself)
    function setBtnLoading(btn, on){
      if (!btn) return;
      if (on){
        btn.setAttribute('data-loading','true');
        btn.disabled = true;
      } else {
        btn.removeAttribute('data-loading');
        btn.disabled = false;
      }
    }
    async function withBtnLoading(btn, fn){
      setBtnLoading(btn, true);
      try { return await fn(); }
      finally { setBtnLoading(btn, false); }
    }

    // Loading overlay helpers (kept for long ops)
    function showLoading(msg='Working…'){
      $('#loadingMsg').textContent = msg;
      $('#loading').classList.add('show');
      $('#loading').setAttribute('aria-hidden','false');
    }
    function hideLoading(){
      $('#loading').classList.remove('show');
      $('#loading').setAttribute('aria-hidden','true');
    }

    // Sidebar (mobile)
    const body = document.body;
    function openSidebar(){ body.classList.add('sidebar-open'); $('#sidebarBackdrop').setAttribute('aria-hidden','false'); }
    function closeSidebar(){ body.classList.remove('sidebar-open'); $('#sidebarBackdrop').setAttribute('aria-hidden','true'); }
    function closeSidebarOnMobile(){
      if (window.matchMedia('(max-width: 980px)').matches) closeSidebar();
    }
    $('#sidebarToggle').addEventListener('click', openSidebar);
    $('#sidebarClose').addEventListener('click', closeSidebar);
    $('#sidebarBackdrop').addEventListener('click', closeSidebar);

    // ---------- state ----------
    let TAGS = [];
    let VIEW = [];
    let CURRENT_TICKET = null;

    // ---------- filters & table ----------
    function toMidnightTS(iso){ // "YYYY-MM-DD" -> timestamp at 00:00 local
      if (!iso) return null;
      const d = new Date(iso + 'T00:00:00');
      return isNaN(d) ? null : d.getTime();
    }
    function endOfDayTS(iso){  // inclusive end-of-day
      const t = toMidnightTS(iso);
      return t == null ? null : (t + 24*60*60*1000 - 1);
    }

    function computeStats(){
      const pending = TAGS.filter(r => ltrim(r.status) === 'pending').length;
      const done    = TAGS.filter(r => ltrim(r.status) === 'done').length;
      $('#statPending').textContent = pending;
      $('#statDone').textContent = done;
      $('#statTotal').textContent = TAGS.length;
    }

    function applyFilters(){
      const q  = ltrim($('#searchBox').value);
      const st = $('#statusSel').value;

      const startTS = toMidnightTS($('#startDate').value); // may be null
      const endTS   = endOfDayTS($('#endDate').value);     // may be null

      VIEW = TAGS.filter(row => {
        // status
        const statusOk = st === 'all' ? true : (ltrim(row.status) === st);
        if (!statusOk) return false;

        // search text (ticket/driver/email/material)
        if (q){
          const hay = [
            row.ticketNo || row.id || '',
            row.driverName || '',
            row.email || '',
            row.material || '',
          ].join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }

        // date window (uses updatedAt)
        const u = row.updatedAt || row.UpdatedAt || '';
        if (startTS != null || endTS != null){
          const ts = isNaN(new Date(u)) ? null : new Date(u).getTime();
          if (ts == null) return false;
          if (startTS != null && ts < startTS) return false;
          if (endTS   != null && ts > endTS)   return false;
        }

        return true;
      });

      renderRows();
    }

    function renderRows(){
      const tb = $('#rows');
      if (!VIEW.length){
        tb.innerHTML = `<tr><td colspan="5" class="muted-small" style="text-align:center;">No results.</td></tr>`;
        $('#resultMeta').textContent = 'Showing 0 results';
        return;
      }
      tb.innerHTML = VIEW.map(r => `
        <tr>
          <td class="col-ticket">
            <a href="#" class="ticket-link" data-id="${(r.ticketNo||r.id||'').toString().replace(/"/g,'&quot;')}">
              ${r.ticketNo || r.id || '-'}
            </a>
          </td>
          <td>${r.driverName || '-'}</td>
          <td class="col-email">${r.email || '-'}</td>
          <td class="col-status status-cell">${statusBadge(r.status || '-')}</td>
          <td class="col-updated">${fmtDateTime(r.updatedAt || r.UpdatedAt || '')}</td>
        </tr>
      `).join('');
      $('#resultMeta').textContent = `Showing ${VIEW.length} result${VIEW.length>1?'s':''}`;
    }

    async function loadTable(opts = { showOverlay: true }){
      const useOverlay = opts && opts.showOverlay !== false;
      try {
        if (useOverlay) showLoading('Loading data…');
        const r = await fetch('/api/admin/tags');
        if (r.status === 401 || r.status === 403) { location.href = '/'; return; }
        const j = await r.json();
        const p = j.profile || {};
        const name = p.fullName || p.name || p.email || 'Admin';
        $('#adminName').textContent = `Welcome, ${name}`;
        const small = $('#adminNameSmall'); if (small) small.textContent = `Welcome, ${name}`;

        TAGS = Array.isArray(j.tags) ? j.tags.map(t => ({
          id: t.id || t.ticketNo || t['Ticket No'] || '',
          ticketNo: t.ticketNo || t['Ticket No'] || t.id || '',
          driverName: t.driverName || t['Driver Name'] || t.Driver || '',
          email: t.email || t.Email || '',
          material: t.material || t['Type of Material'] || '',
          status: t.status || t.Status || '',
          updatedAt: t.updatedAt || t.UpdatedAt || '',
        })) : [];

        computeStats();

        // keep user's current filter selections
        applyFilters();
      } catch (e){
        console.error(e);
        alert('Failed to load table.');
      } finally {
        if (useOverlay) hideLoading();
      }
    }

    // ---------- meta dropdowns ----------
    async function loadMeta(selectIds = {driver:'#driverSel', trailer:'#trailerSel'}){
      const r = await fetch('/api/admin/meta');
      if (r.status === 401 || r.status === 403) { location.href = '/'; return; }
      const j = await r.json();
      const drivers = Array.isArray(j.drivers) ? j.drivers : [];
      const types   = Array.isArray(j.trailerTypes) ? j.trailerTypes : [];

      const dSel = $(selectIds.driver);
      const tSel = $(selectIds.trailer);

      if (dSel) {
        dSel.innerHTML = `<option value="">Select driver…</option>` +
          drivers.map(n => `<option value="${n.replace(/"/g,'&quot;')}">${n}</option>`).join('');
      }
      if (tSel) {
        tSel.innerHTML = `<option value="">Select type…</option>` +
          types.map(n => `<option value="${n.replace(/"/g,'&quot;')}">${n}</option>`).join('');
      }
    }

    // ---------- actions ----------
    $('#openAdd').addEventListener('click', async (e) => {
      await withBtnLoading(e.currentTarget, async () => {
        await loadMeta({driver:'#driverSel', trailer:'#trailerSel'});
        $('#addForm').reset();
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        $('#addForm').date.value = `${yyyy}-${mm}-${dd}`;
        setOpen($('#addModal'), true);
        closeSidebarOnMobile();
      });
    });

    $$('#addModal [data-close]').forEach(el => el.addEventListener('click', () => setOpen($('#addModal'), false)));

    $('#addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      if (!body.date || !body.ticketNo || !body.driverName) { alert('Date, Ticket No and Driver Name are required.'); return; }

      const btn = $('#addSaveBtn');
      await withBtnLoading(btn, async () => {
        try {
          showLoading('Saving ticket…');
          const r = await fetch('/api/admin/tickets', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          const j = await r.json();
          if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to add ticket');
          setOpen($('#addModal'), false);
          await loadTable({ showOverlay: false });
          alert('Ticket added.');
        } catch (err) {
          console.error(err);
          alert(err.message || 'Could not add ticket.');
        } finally {
          hideLoading();
        }
      });
    });

    $('#openUpload').addEventListener('click', (e) => {
      closeSidebarOnMobile();
      $('#csvInput').value = '';
      $('#csvInput').click();
    });

    $('#csvInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!/\.csv$/i.test(file.name) && file.type !== 'text/csv') {
        if (!confirm('File is not .csv — try importing anyway?')) return;
      }
      try {
        showLoading('Uploading & importing CSV…');
        const text = await file.text();
        const r = await fetch('/api/admin/import-csv', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ csv: text })
        });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.message || 'Import failed.');
        const s = j.summary || {};
        alert(`Import complete.\nAdded: ${s.added||0}\nUpdated: ${s.updated||0}\nSkipped (Carrier present): ${s.skippedCarrier||0}\nInvalid rows: ${s.invalid||0}`);
        await loadTable({ showOverlay: false });
      } catch (err) {
        console.error(err);
        alert(err.message || 'Could not import CSV.');
      } finally {
        hideLoading();
      }
    });

    $('#openTagLists').addEventListener('click', (e) => {
      setBtnLoading(e.currentTarget, true);
      location.href = '/tag-lists';
    });
    $('#openUsers').addEventListener('click', (e) => {
      setBtnLoading(e.currentTarget, true);
      location.href = '/admin/users';
    });
    $('#openDraftTickets').addEventListener('click', (e) => {
      setBtnLoading(e.currentTarget, true);
      location.href = '/draft-tickets';
    });

    // ---------- click ticket → view/edit ----------
    $('#rows').addEventListener('click', async (e) => {
      const a = e.target.closest('.ticket-link');
      if (!a) return;
      e.preventDefault();
      await openView(a.dataset.id);
    });

    async function openView(ticketId){
      CURRENT_TICKET = ticketId;
      showLoading('Loading ticket…');
      try{
        await loadMeta({driver:'#viewDriverSel', trailer:'#viewTrailerSel'});
        const r = await fetch(`/api/admin/tickets/${encodeURIComponent(ticketId)}`);
        if (r.status === 401 || r.status === 403) { location.href = '/'; return; }
        const j = await r.json();
        if (!j.ok) { alert(j.message || 'Not found'); return; }
        $('#viewId').textContent = ticketId;
        fillViewForm(j.ticket);
        setViewMode(true);
        setOpen($('#viewModal'), true);
      } finally {
        hideLoading();
      }
    }

    function fillViewForm(t = {}){
      const f = $('#viewForm');
      f.date.value        = toISODate(v(t,'Date'));
      f.ticketNo.value    = v(t,'Ticket No','Ticket No.');
      setSelectValue($('#viewDriverSel'), v(t,'Driver Name','Driver'));

      f.truckStart.value  = v(t,'Truck Start');
      f.truckNo.value     = v(t,'Truck No');
      setSelectValue($('#viewTrailerSel'), v(t,'Trailer Type','Trailer type','Trailer'));

      f.subHauler.value   = v(t,'Sub Hauler');
      f.primeCarrier.value= v(t,'Prime Carrier');
      f.shipper.value     = v(t,'Shipper');
      f.origin.value      = v(t,'Point of Origin');

      f.originCity.value  = v(t,'Origin City','City');
      f.poNo.value        = v(t,'PO No','PO#','PO no');
      f.jobName.value     = v(t,'Job Name');
      f.jobNo.value       = v(t,'Job No');
      f.destination.value = v(t,'Destination');
      f.city.value        = v(t,'City');
    }

    function setViewMode(locked){
      $$('#viewForm input, #viewForm select').forEach(el => { el.disabled = locked; });
      $('#viewForm').ticketNo.disabled = true;
      $('#editBtn').style.display = locked ? 'inline-flex' : 'none';
      $('#saveBtn').style.display = locked ? 'none' : 'inline-flex';
      $('#cancelEditBtn').style.display = locked ? 'none' : 'inline-flex';
    }

    $('#editBtn').addEventListener('click', () => setViewMode(false));
    $('#cancelEditBtn').addEventListener('click', () => { setViewMode(true); if (CURRENT_TICKET) openView(CURRENT_TICKET); });
    $$('#viewModal [data-close]').forEach(el => el.addEventListener('click', () => setOpen($('#viewModal'), false)));

    $('#viewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!CURRENT_TICKET) return;
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      if (!body.date || !body.driverName) { alert('Date and Driver Name are required.'); return; }

      await withBtnLoading($('#saveBtn'), async () => {
        try {
          showLoading('Updating ticket…');
          const r = await fetch(`/api/admin/tickets/${encodeURIComponent(CURRENT_TICKET)}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to update ticket');
          await loadTable({ showOverlay: false });
          alert('Ticket updated.');
          setViewMode(true);
          setOpen($('#viewModal'), false);
        } catch (err) {
          console.error(err);
          alert(err.message || 'Could not update ticket.');
        } finally {
          hideLoading();
        }
      });
    });

    $('#deleteBtn').addEventListener('click', async (e) => {
      if (!CURRENT_TICKET) return;
      if (!confirm(`Delete ticket ${CURRENT_TICKET}? This also removes its Driver stub.`)) return;

      await withBtnLoading(e.currentTarget, async () => {
        try {
          showLoading('Deleting…');
          const r = await fetch(`/api/admin/tickets/${encodeURIComponent(CURRENT_TICKET)}`, { method:'DELETE' });
          const j = await r.json();
          if (!r.ok || j.ok === false) throw new Error(j.message || 'Failed to delete');
          setOpen($('#viewModal'), false);
          await loadTable({ showOverlay: false });
          alert('Ticket deleted.');
        } catch (err) {
          console.error(err);
          alert(err.message || 'Could not delete ticket.');
        } finally {
          hideLoading();
        }
      });
    });

    // ---------- filter events ----------
    $('#statusSel').addEventListener('change', applyFilters);
    $('#searchBox').addEventListener('input', applyFilters);
    $('#startDate').addEventListener('change', applyFilters);
    $('#endDate').addEventListener('change', applyFilters);
    $('#clearDates').addEventListener('click', () => {
      $('#startDate').value = '';
      $('#endDate').value = '';
      applyFilters();
    });

    // Refresh button: no full overlay, just spinner on the button
    $('#refreshBtn').addEventListener('click', (e) => withBtnLoading(e.currentTarget, () => loadTable({ showOverlay: false })));

    // go!
    loadTable({ showOverlay: true });
  </script>
</body>
</html>
